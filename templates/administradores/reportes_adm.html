{% extends 'core/base.html' %}

{% block contenido %}
{% load static %} {# Archivos #}

<div class="container" style="margin-top: 150px;">

    <div class="row">

        <div class="col-12 col-lg-4 mb-2">
            <button type="button" onclick="reporteMaestro()" class="btn btn-success"><i style="font-size: 20px;"
                    class="far fa-file-word"></i>&nbsp; Reporte Maestro</button>
        </div>

        <div class="col-12 col-lg-4 d-flex justify-content-center mb-2"><strong>Periodo {{periodoActual}}</strong></div>

        <div class="col-12 col-lg-4 mb-2">
            <div class="d-flex justify-content-end">
                <form  method="POST">
                    {% csrf_token %}
                    <label for="periodos"><strong>Periodos</strong></label>
                    
                    <select onchange="this.form.submit()" class="form-control" name="periodo_id" id="periodo">
                        <option selected value="{{periodoActual.id}}">{{periodoActual}}</option>
                        {% for periodo in periodos %}
                        <option value="{{periodo.id}}">{{ periodo }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

    </div>
</div>

<section class="container">

    {% csrf_token %}
    <table id="reportes" class="table table-bordered table-striped text-center dt-responsive" style="width: 100%;">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Apellido(s)</th>
                <th>Nombre(s)</th>
                <th>PDF</th>
                <th>Anexos</th>
            </tr>
        </thead>
        <tbody>
            <div class="reportes">
                {% for reporte in reportes %}
                <tr>
                    <td>{{reporte.fecha_de_creacion|date:"d-M-Y"}}</td>
                    <td>{{reporte.usuario.apellido}}</td>
                    <td> {{reporte.usuario.nombre}}</td>

                    <td><a download href="{{reporte.reporte.url}}"><i style="font-size:35px; color:red;"
                                class="far fa-file-pdf"></i></a></td>
                    <td><a download href="{{reporte.anexo.url}}"><i style="font-size:35px;"
                                class="far fa-file-archive"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </div>

        </tbody>
    </table>

</section>

{% endblock %}

<!--JS Code-->
{% block JSCode %}
<!--Data table -->
<script src="{% static 'DataTables/datatables.min.js'%}"></script>
<link rel="stylesheet" href="{% static 'DataTables/datatables.min.css'%}">
<script>
    $('#reportes').DataTable({
        "language": {
            "lengthMenu": "Mostrar _MENU_ usuarios",
            "zeroRecords": "No se encontraron resultados",
            "info": "<small>Mostrando usuarios del _START_ al _END_ de un total de _TOTAL_ registros</small>",
            "infoEmpty": "No existen usuarios",
            "infoFiltered": "(filtrado de un total de _MAX_ usuarios",
            "sSearch": "Buscar:",
            "oPaginate": {
                "sFirst": "Primero",
                "sLast": "Ultimo",
                "sNext": "Siguiente",
                "sPrevious": "Anterior",
            },
            "sProcessing": "Procesando..."
        },
        dom: 'lifBtp',
        "pageLength": 20,
        "lengthMenu": [[5, 10, 20, 25, 50, -1], [5, 10, 20, 25, 50, "Todos"]],
        "order": [[0, "asc"]],
        responsive: true,

    }); // Fin Reportes DataTable
</script>
<!--Fin datatables-->
<script>

    function reporteMaestro() {
        var csrfmiddlewaretoken = $('input[name="csrfmiddlewaretoken"]').val().trim();
        var periodo_id = $('select[name="periodo_id"] option:selected').val();
        var periodoActual = $('select[name="periodo_id"] option:selected').text();

        Swal.fire({
            title: 'Reporte Maestro',
            icon: 'info',
            text: 'Generando reporte, espere un momento',
            allowOutsideClick: false,
            timerProgressBar: true,
            onBeforeOpen: () => {
                Swal.showLoading()
            },
        })

        var req = new XMLHttpRequest();
        req.open("POST", "{%  url 'administradores:reporteMaestro' %}", true);

        req.responseType = "blob";
        var formData = new FormData();
        formData.append('periodoActual', periodo_id)
        formData.append('csrfmiddlewaretoken', csrfmiddlewaretoken)

        req.onload = function (event) {
            var blob = req.response;
            var link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = "Reporte Maestro " + periodoActual + ".docx";
            link.click();

            Swal.fire({
                title: 'Reporte Maestro',
                icon: 'success',
                html: '<p>Reporte maestro del periodo</p>' +
                    `${periodoActual}` + '<p>generado con Ã©xito</p>',
            })
        };
        req.send(formData);
    }


</script>
{% endblock %}