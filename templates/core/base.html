<!DOCTYPE html>
<html lang="es">

<head>
    {% load static %} {# Archivos #}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1 shrink-to-fit=no">
    <title>Sistema de control</title>
    <link rel="shortcut icon" href="{% static 'media/logo.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/nabvar.css' %}">
    {% block head %}
    {% endblock %}
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom justify-content-between">
                
        <a class="navbar-brand">
            <img src="{% static 'media/logo.png' %}" width="55px;">
        </a>
            
        <span class="navbar-text text-center">
            Coordinación de Astrofísica<br>Sistema de Reportes
        </span>
           
        <a class="navbar-brand">
            <img src="{% static 'media/conacyt.png' %}" width="55px">
        </a>
        <button id="menu-toggle" class="navbar-toggler col-12" type="button" data-toggle="collapse"
        data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
        
    </nav>
    <div id="content-wrapper" class="d-flex">
        
        <!-- Sidebar -->
        {% if request.user.is_authenticated %}
        <div id="sidebar-container" class="bg-light border-right">
            {% if request.user.is_superuser %}
            <div class="logo">Administrador</div>
            <div class="menu list-group-flush">
                {% if request.path != '/home-adm' %}
                <a class="list-group-item list-group-item-action bg-light p-3 border-0"
                    href="{% url 'administradores:home-adm'  %}">
                    <i class="fas fa-home">&nbsp; Inicio</i></a>

                <a href="#" onclick="cerrarSesion()"
                    class="list-group-item list-group-item-action bg-light p-3 border-0">
                    <i class="fas fa-sign-out-alt"></i>&nbsp; Cerrar Sesión</a>

                <a class="list-group-item list-group-item-action bg-light p-3 border-0"
                    href="javascript:history.back()">
                    <i class="fas fa-arrow-circle-left"></i>&nbsp; Regresar</a>

                {% if request.path != '/perfil_adm' %}
                <a href="{% url 'administradores:perfil_adm' %}"
                    class="list-group-item list-group-item-action bg-light p-3 border-0">
                    <i class="fas fa-user">&nbsp;</i> Administrador</a>
                {% endif %}

                {% if request.path != '/investigadores' %}
                <a href="{% url 'administradores:reportes' %}"
                    class="list-group-item list-group-item-action bg-light p-3 border-0">
                    <i class="fas fa-users">&nbsp;</i>Usuarios</a>
                {% endif %}

                {% if request.path != '/reportes-adm' %}
                <a href="{% url 'administradores:reportes_adm' %}"
                    class="list-group-item list-group-item-action bg-light p-3 border-0">
                    <i class="far fa-file-alt"></i>&nbsp;Reportes</a>
                {% endif %}

                {% endif %}
            </div>
            {% else %}
            <div class="logo">{{ user.nombre}} {{user.apellido}}</div>
            <div class="menu list-group-flush">
                <a class="list-group-item list-group-item-action bg-light p-3 border-0"
                    href="{% url 'administradores:home-adm'  %}">
                    <i class="fas fa-home">&nbsp; Inicio</i></a>

                <a href="#" onclick="cerrarSesion()"
                    class="list-group-item list-group-item-action bg-light p-3 border-0">
                    <i class="fas fa-sign-out-alt"></i>&nbsp; Cerrar Sesión</a>

                <a class="list-group-item list-group-item-action bg-light p-3 border-0"
                    href="javascript:history.back()">
                    <i class="fas fa-arrow-circle-left"></i>&nbsp; Regresar</a>
                <hr>

                {% if request.path == '/home' %}
                <a href="http://bit.ly/Guía-Reportes-INAOE-Astro" target="blank"
                    class="list-group-item list-group-item-action bg-light p-3 border-0"><i
                        class="fas fa-book-open"></i> Guía rápida PDF</a>
                {% endif %}

                {% if request.path != '/home' %}

                {% if request.path != '/biblioteca-personal' %}
                <a href="{% url 'biblioteca:biblioteca_personal' %}"
                    class="list-group-item list-group-item-action bg-light p-3 border-0"><i class="fas fa-book"></i>
                    Biblioteca personal</a>
                {% endif %}

                {% if request.path != '/busqueda-ads' %}
                <a href="{% url 'biblioteca:busqueda_biblioteca' %}"
                    class="list-group-item list-group-item-action bg-light p-3 border-0"><i class="fas fa-search"></i>
                    Búsqueda ADS</a>
                {% endif %}

                {% if request.path != '/reporte-productividad' %}
                <a href="{% url 'reportes:reporte-productividad' %}"
                    class="list-group-item list-group-item-action bg-light p-3 border-0"><i class="far fa-file-alt"></i>
                    Reportes productividad</a>
                {% endif %}

                {% if request.path == '/reporte-productividad' %}
                <hr>
                <p class="text-center text-white bg-primary list-group-item">Reporte de productividad</p>
                <form action="{% url 'reportes:generarReporte' %}">
                    <input type="hidden" value="{{periodoActual.id}}" name="periodo">
                    <button onclick="notificacion.vistaPrevia()"
                        class="text-white list-group-item list-group-item-action bg-success p-3 border-0">
                        <i class="far fa-eye"></i> Vista Previa</button>
                </form>

                <a class="text-white list-group-item list-group-item-action bg-info p-3 border-0"
                    href="{% url 'reportes:reportesEnviados' %}"><i class="fas fa-history"></i> Historico</a>

                <button class="text-white list-group-item list-group-item-action bg-danger p-3 border-0"
                    onclick="finalizarReporte()"><i class="fas fa-check"></i>
                    Finalizar Reporte
                </button>
                {% endif %}

                {% endif %}

            </div>
            {% endif %}
        </div>
        {% endif %}
        <!-- Fin sidebar -->

        <div id="page-content-wrapper" class="w-100">
            
            <div id="content" class="container-fluid pt-2 pl-2 pr-2">
                {% block contenido %}{% endblock %}
            </div>
        </div>

    </div>

    {% if request.user.is_authenticated %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script>
        $("#menu-toggle").click(function (e) {
            e.preventDefault();
            $('#content-wrapper').toggleClass("toggled");
            $('#btn-collaps').toggleClass("far fa-caret-square-right");

        });
    </script>
    <script>
        let timer;

        //Control de sesion
        $(document).ready(function () {
            timer = new Timer(function () {
                let timerInterval
                Swal.fire({
                    title: 'Sesión por caducar',
                    html: 'Su sesión expira en <b></b> seg. <br> ¿Desea ampliarla? <br> <br> <i style="font-size:100px" class="far fa-clock text-danger"></i>',
                    allowOutsideClick: false,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '<i class="fas fa-check"> Aceptar</i>',
                    timer: 60000,
                    timerProgressBar: true,

                    onBeforeOpen: () => {
                        timerInterval = setInterval(() => {
                            const content = Swal.getContent()
                            if (content) {
                                const b = content.querySelector('b')
                                if (b) {
                                    b.textContent = parseInt(Swal.getTimerLeft() / 1000)
                                }
                            }
                        }, 100)
                    },
                    onClose: () => {
                        clearInterval(timerInterval);
                        Swal.fire({
                            title: 'Sesión terminada',
                            icon: 'error',
                            text: 'Su sesión caduco, en breve se redireccionara al login',
                            allowOutsideClick: false,
                            timer: 5000,
                            timerProgressBar: true,
                            onClose: () => {
                                $(location).attr('href', '{% url "logout" %}');
                            },

                        }).then((result) => {
                            $(location).attr('href', '{% url "logout" %}');
                        });

                    },
                }).then((result) => {
                    if (result.value) {
                        $.ajax({
                            type: "GET",
                            url: '{% url "reportes:Ampliar-sesion" %}'
                        })
                            .done(function (response) {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Sesión ampliada',

                                    text: 'Su sesión terminara a las ' + response.nuevaSesion,
                                    timer: 5000,
                                    timerProgressBar: true,
                                })
                                clearInterval(timerInterval);
                            })
                            .fail(function () {
                                sesionTerminada();
                            });
                    }
                });
            }, 540000)

        });

        function Timer(fn, t) {
            var timerObj = setInterval(fn, t);

            this.stop = function () {
                if (timerObj) {
                    clearInterval(timerObj);
                    timerObj = null;
                }
                return this;
            }

            // start timer using current settings (if it's not already running)
            this.start = function () {
                if (!timerObj) {
                    this.stop();
                    timerObj = setInterval(fn, t);
                }
                return this;
            }

            // start with new or original interval, stop current interval
            this.reset = function (newT = t) {
                t = newT;
                return this.stop().start();
            }
        }

        function cerrarSesion() {
            Swal.fire({
                title: 'Finalizar sesión',
                text: '¿Realmente quiere finalizar su sesión?',
                icon: 'question',
                allowOutsideClick: false,
                showCancelButton: true,
                cancelButtonColor: '#d33',
                confirmButtonText: '<i class="fas fa-check"></i> Aceptar',
                cancelButtonText: '<i class="fas fa-times"></i> Cancelar'
            }).then((result) => {
                if (result.value) {
                    $(location).attr('href', '{% url "logout" %}');
                }

            });
        }

    </script>
    <script src="{% static 'js/sweetalert.js' %}"></script>

    {% endif %}
    {% block JSCode %}

    {% endblock %}
</body>

</html>